name: Merge Feature Branch to Develop

on:
  push:
    branches:
      - 'historia**'

jobs:
  merge-to-develop:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verificar palabra clave en commit
        id: check-keyword
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"LISTO_PARA_DESARROLLO"* ]]; then
            echo "keyword_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Palabra clave 'LISTO_PARA_DESARROLLO' encontrada en el commit"
          else
            echo "keyword_found=false" >> $GITHUB_OUTPUT
            echo "‚ùå Palabra clave 'LISTO_PARA_DESARROLLO' no encontrada en el commit"
            echo "Mensaje del commit: ${{ github.event.head_commit.message }}"
          fi
      
      - name: Configurar Git
        if: steps.check-keyword.outputs.keyword_found == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: Actualizar rama de funcionalidad con develop
        if: steps.check-keyword.outputs.keyword_found == 'true'
        run: |
          echo "üîÑ Actualizando rama de funcionalidad con develop..."
          git fetch origin develop
          git checkout ${{ github.ref_name }}
          git merge origin/develop --no-edit
          git push origin ${{ github.ref_name }}
          echo "‚úÖ Rama de funcionalidad actualizada con develop"
      
      - name: Instalar dependencias Python
        if: steps.check-keyword.outputs.keyword_found == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Ejecutar pruebas unitarias
        if: steps.check-keyword.outputs.keyword_found == 'true'
        run: |
          echo "üß™ Ejecutando pruebas unitarias..."
          python -m unittest discover -s tests -v
          echo "‚úÖ Todas las pruebas pasaron exitosamente"
      
      - name: Ejecutar an√°lisis de cobertura
        if: steps.check-keyword.outputs.keyword_found == 'true'
        run: |
          echo "üìä Ejecutando an√°lisis de cobertura..."
          python -m coverage run -m unittest discover -s tests -v
          python -m coverage html
          echo "‚úÖ An√°lisis de cobertura completado"
      
      - name: Mezclar rama de funcionalidad a develop
        if: steps.check-keyword.outputs.keyword_found == 'true'
        uses: tukasz/direct-merge-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          source-branch: ${{ github.ref_name }}
          target-branch: develop
      
      - name: Notificar √©xito
        if: steps.check-keyword.outputs.keyword_found == 'true'
        run: |
          echo "üéâ ¬°Merge exitoso!"
          echo "Rama ${{ github.ref_name }} mezclada exitosamente a develop"
          echo "Todas las pruebas pasaron correctamente"
      
      - name: Notificar que no se ejecut√≥
        if: steps.check-keyword.outputs.keyword_found == 'false'
        run: |
          echo "‚ÑπÔ∏è Workflow no ejecutado"
          echo "Para activar el merge autom√°tico, incluye la palabra clave 'LISTO_PARA_DESARROLLO' en tu mensaje de commit"
